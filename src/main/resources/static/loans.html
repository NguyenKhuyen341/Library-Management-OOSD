<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản Lý Mượn Trả - UniLib</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary-color: #4f46e5; --sidebar-width: 260px; --bg-color: #f3f4f6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: white; border-right: 1px solid #e5e7eb; padding: 20px; }
        .main-content { margin-left: var(--sidebar-width); padding: 30px; }
        .nav-link { color: #64748b; padding: 12px 15px; border-radius: 10px; font-weight: 500; margin-bottom: 5px; display: flex; align-items: center; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background-color: #eef2ff; color: var(--primary-color); }
        .nav-link i { margin-right: 12px; width: 20px; text-align: center; }
        .brand-logo { font-size: 1.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; }
        .table-container { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        /* BADGE STATUS */
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-borrowing { background-color: #e0e7ff; color: #4338ca; } /* Xanh dương */
        .status-returned { background-color: #dcfce7; color: #166534; } /* Xanh lá */
        .status-pending { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; } /* Vàng (Mới) */

        .stat-card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand-logo"><i class="fas fa-layer-group me-2"></i> UniLib</div>
    <nav class="nav flex-column">
        <a class="nav-link" href="dashboard.html"><i class="fas fa-th-large"></i> Dashboard</a>
        <a class="nav-link" href="admin.html"><i class="fas fa-book"></i> Quản lý Sách</a>
        <a class="nav-link" href="users.html"><i class="fas fa-users"></i> Độc giả</a>
        <a class="nav-link active" href="loans.html"><i class="fas fa-clipboard-list"></i> Mượn Trả</a>
        <a class="nav-link" href="admin-contacts.html"><i class="fas fa-envelope"></i> Liên hệ</a>
        <a class="nav-link text-danger" href="index.html"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
    </nav>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold m-0">Quản lý Mượn Trả</h3>
            <p class="text-muted m-0">Theo dõi quá trình lưu thông sách</p>
        </div>
        <button class="btn btn-primary px-4 py-2 rounded-3 fw-bold shadow-sm" onclick="openLoanModal()">
            <i class="fas fa-plus me-2"></i> Tạo phiếu mượn
        </button>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card border-warning" style="border-left-color: #eab308 !important;">
                <h6 class="text-uppercase text-muted small fw-bold">Chờ lấy sách</h6>
                <h2 class="fw-bold text-warning m-0" id="count-pending">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border-primary">
                <h6 class="text-uppercase text-muted small fw-bold">Đang mượn</h6>
                <h2 class="fw-bold text-primary m-0" id="count-borrowing">0</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card border-success" style="border-left-color: #10b981 !important;">
                <h6 class="text-uppercase text-muted small fw-bold">Đã trả</h6>
                <h2 class="fw-bold text-success m-0" id="count-returned">0</h2>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-hover align-middle">
            <thead class="bg-light">
            <tr class="text-secondary small text-uppercase">
                <th>ID</th>
                <th>Người mượn</th>
                <th>Sách</th>
                <th>Ngày hẹn/mượn</th>
                <th>Hạn trả</th>
                <th>Trạng thái</th>
                <th class="text-end">Hành động</th>
            </tr>
            </thead>
            <tbody id="loan-table-body"></tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function formatDate(dateString) {
        if (!dateString) return '---';
        return dateString;
    }

    async function loadLoans() {
        try {
            const res = await fetch('/api/loans');
            const loans = await res.json();

            const tbody = document.getElementById('loan-table-body');
            tbody.innerHTML = '';

            let cPending = 0, cBorrowing = 0, cReturned = 0;

            loans.forEach(loan => {
                let statusBadge = '';
                let actionBtn = '';
                let dateDisplay = loan.borrowDate; // Ngày hiển thị

                // --- 1. LOGIC TRẠNG THÁI ---
                if (loan.status === 'PENDING') {
                    cPending++;
                    statusBadge = `<span class="status-badge status-pending">Chờ lấy sách</span>`;
                    // Nút Giao Sách
                    actionBtn = `<button class="btn btn-sm btn-primary fw-bold" onclick="approveLoan(${loan.id}, '${loan.reader.fullName}')">
                                    <i class="fas fa-check-double me-1"></i> Giao sách
                                 </button>`;
                }
                else if (loan.status === 'BORROWING') {
                    cBorrowing++;
                    statusBadge = `<span class="status-badge status-borrowing">Đang mượn</span>`;
                    // Nút Trả Sách
                    actionBtn = `<button class="btn btn-sm btn-outline-success fw-bold" onclick="returnBook(${loan.id}, '${loan.book.title}', '${loan.reader.fullName}')">
                                    <i class="fas fa-undo me-1"></i> Trả sách
                                 </button>`;
                }
                else {
                    cReturned++;
                    statusBadge = `<span class="status-badge status-returned">Đã trả</span>`;
                    actionBtn = `<span class="text-muted small"><i class="fas fa-check"></i> Hoàn tất</span>`;
                }

                // --- 2. LOGIC ẢNH THẬT ---
                const book = loan.book;
                let coverImg = `https://ui-avatars.com/api/?name=${encodeURIComponent(book.title)}&background=random`;
                if(book.image && book.image.trim() !== "") coverImg = `/images/${book.image}`;

                const row = `
                    <tr>
                        <td class="text-muted">#${loan.id}</td>
                        <td>
                            <div class="fw-bold">${loan.reader ? loan.reader.fullName : 'Unknown'}</div>
                            <div class="small text-muted">${loan.reader ? loan.reader.readerCode : '---'}</div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${coverImg}" class="rounded me-2 border" width="30" height="40" style="object-fit: cover;">
                                <div class="fw-bold text-dark text-truncate" style="max-width: 150px;" title="${book.title}">${book.title}</div>
                            </div>
                        </td>
                        <td>${formatDate(dateDisplay)}</td>
                        <td class="fw-bold">${formatDate(loan.dueDate)}</td>
                        <td>${statusBadge}</td>
                        <td class="text-end">${actionBtn}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Cập nhật thống kê
            document.getElementById('count-pending').innerText = cPending;
            document.getElementById('count-borrowing').innerText = cBorrowing;
            document.getElementById('count-returned').innerText = cReturned;

        } catch (e) { console.error(e); }
    }

    // --- HÀM 1: GIAO SÁCH (DUYỆT PENDING -> BORROWING) ---
    function approveLoan(loanId, readerName) {
        Swal.fire({
            title: 'Giao sách cho sinh viên?',
            text: `Xác nhận ${readerName} đã đến nhận sách? Hạn trả (14 ngày) sẽ bắt đầu tính từ bây giờ.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4f46e5',
            confirmButtonText: 'Xác nhận giao'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/loans/approve/${loanId}`, { method: 'POST' });
                    if (res.ok) {
                        Swal.fire('Thành công', 'Đã giao sách!', 'success');
                        loadLoans();
                    } else {
                        Swal.fire('Lỗi', await res.text(), 'error');
                    }
                } catch (e) { Swal.fire('Lỗi server', '', 'error'); }
            }
        });
    }

    // --- HÀM 2: TRẢ SÁCH (BORROWING -> RETURNED) ---
    function returnBook(loanId, bookTitle, readerName) {
        Swal.fire({
            title: 'Xác nhận trả sách?',
            html: `Độc giả: <b>${readerName}</b><br>Sách: <b>${bookTitle}</b>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            confirmButtonText: 'Đồng ý, Đã nhận lại'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/api/loans/return/${loanId}`, { method: 'POST' });
                    if (res.ok) {
                        Swal.fire('Thành công!', 'Đã trả sách về kho.', 'success');
                        loadLoans();
                    } else {
                        Swal.fire('Lỗi!', await res.text(), 'error');
                    }
                } catch (e) { Swal.fire('Lỗi!', 'Lỗi server', 'error'); }
            }
        });
    }

    function openLoanModal() {
        Swal.fire('Thông báo', 'Admin vui lòng thao tác trên bảng bên dưới.', 'info');
    }

    loadLoans();
</script>
</body>
</html>