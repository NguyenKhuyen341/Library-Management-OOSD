<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniLib - Th∆∞ Vi·ªán S·ªë</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4f46e5; --dark: #1e293b; --light-bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--light-bg); color: var(--dark); }

        /* NAVBAR */
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; }
        .navbar-brand { font-weight: 800; color: var(--primary) !important; font-size: 1.5rem; }
        .nav-link { font-weight: 600; color: #64748b !important; margin: 0 10px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { color: var(--primary) !important; }
        .btn-login { background: transparent; color: var(--primary); font-weight: 700; border: 2px solid rgba(79, 70, 229, 0.1); }
        .btn-register { background: var(--primary); color: white; font-weight: 700; box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39); }

        /* HERO SECTION */
        .hero-section { padding: 100px 0 80px; background: radial-gradient(circle at top right, #eef2ff, transparent 40%), radial-gradient(circle at bottom left, #e0e7ff, transparent 40%); text-align: center; }
        .hero-title { font-size: 3.5rem; font-weight: 800; line-height: 1.2; margin-bottom: 20px; background: linear-gradient(135deg, #1e293b 0%, #4f46e5 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .search-box { background: white; padding: 8px; border-radius: 50px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); max-width: 600px; margin: 0 auto; display: flex; border: 1px solid #e2e8f0; }
        .search-input { border: none; padding: 15px 25px; width: 100%; outline: none; font-size: 1rem; border-radius: 50px; }
        .btn-search { border-radius: 50px; padding: 12px 30px; background: var(--primary); color: white; border: none; font-weight: 600; transition: 0.3s; }
        .btn-search:hover { transform: scale(1.05); }

        /* BOOK CARDS */
        .section-title { font-weight: 800; margin-bottom: 40px; position: relative; display: inline-block; }
        .section-title::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 50px; height: 4px; background: var(--primary); border-radius: 2px; }

        .book-card { border: none; border-radius: 20px; background: white; transition: all 0.3s ease; height: 100%; position: relative; overflow: hidden; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); }
        .book-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px -10px rgba(79, 70, 229, 0.2); }
        .book-badge { position: absolute; top: 20px; left: 20px; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; z-index: 10; }
        .badge-stock { background: #dcfce7; color: #166534; }
        .badge-out { background: #fee2e2; color: #991b1b; }

        .card-img-wrapper { height: 280px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; position: relative; display: block; text-decoration: none; }
        .book-img { height: 220px; width: auto; object-fit: contain; box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: 0.3s; margin: 0 auto; display: block; padding-top: 30px;}
        .book-card:hover .book-img { transform: scale(1.05); }

        .card-body { padding: 25px; }
        .book-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-author { color: #64748b; font-size: 0.9rem; margin-bottom: 20px; }

        .btn-borrow { width: 100%; padding: 12px; border-radius: 12px; font-weight: 600; background: var(--light-bg); color: var(--primary); border: none; transition: 0.2s; }
        .btn-borrow:hover:not(:disabled) { background: var(--primary); color: white; }

        /* FOOTER ƒêEN */
        footer { background: #1a1a1a; color: #aaa; padding: 40px 0; font-size: 0.85rem; margin-top: auto; }
        footer h6 { color: #f59e0b; font-weight: 700; text-transform: uppercase; margin-bottom: 15px; font-size: 0.9rem; } /* M√†u v√†ng cam */
        footer p { margin-bottom: 8px; }

    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="#"><i class="fas fa-book-open-reader me-2"></i>UniLib.</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item"><a class="nav-link active" href="#">Kh√°m ph√°</a></li>
                <li class="nav-item"><a class="nav-link" href="catalog.html">Danh m·ª•c</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">Gi·ªõi thi·ªáu</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Li√™n h·ªá</a></li>
            </ul>
            <div class="d-flex gap-2 align-items-center" id="user-actions"></div>
        </div>
    </div>
</nav>

<section class="hero-section">
    <div class="container">
            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill mb-3 fw-bold">
                üëã Ch√†o m·ª´ng ƒë·∫øn v·ªõi th∆∞ vi·ªán s·ªë
            </span>
        <h1 class="hero-title">T√¨m ngu·ªìn tri th·ª©c<br>ti·∫øp theo c·ªßa b·∫°n</h1>
        <p class="text-muted fs-5 mb-5 w-75 mx-auto">
            Truy c·∫≠p h√†ng ng√†n ƒë·∫ßu s√°ch, t√†i li·ªáu nghi√™n c·ª©u v√† t·∫°p ch√≠ khoa h·ªçc.<br>
            M∆∞·ª£n s√°ch d·ªÖ d√†ng ch·ªâ v·ªõi m·ªôt c√∫ click chu·ªôt.
        </p>

        <div class="search-box">
            <input type="text" class="search-input" id="keyword-input" placeholder="Nh·∫≠p t√™n s√°ch, t√°c gi·∫£ ho·∫∑c ISBN...">
            <button class="btn-search" onclick="doSearch()"><i class="fas fa-search me-2"></i>T√¨m ki·∫øm</button>
        </div>
    </div>
</section>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h3 class="section-title">S√°ch M·ªõi C·∫≠p Nh·∫≠t</h3>
            <p class="text-muted m-0">Nh·ªØng cu·ªën s√°ch v·ª´a ƒë∆∞·ª£c th√™m v√†o kho tu·∫ßn n√†y</p>
        </div>
        <a href="#" class="text-decoration-none fw-bold text-primary">Xem t·∫•t c·∫£ <i class="fas fa-arrow-right ms-1"></i></a>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="book-list">
        <div class="text-center w-100 py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu s√°ch...</p>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4 mb-md-0">
                <h6>LI√äN H·ªÜ</h6>
                <p><i class="fas fa-phone me-2"></i> ƒêi·ªán tho·∫°i: 0369-xxx-xxx</p>
                <p><i class="fas fa-envelope me-2"></i> Email: contact@unilib.edu.vn</p>
            </div>
            <div class="col-md-4 mb-4 mb-md-0">
                <h6>TH√îNG TIN M√îN H·ªåC</h6>
                <p>M√¥n h·ªçc: X√¢y d·ª±ng ph·∫ßn m·ªÅm h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng (OOSD)</p>
                <p>Gi√°o vi√™n h∆∞·ªõng d·∫´n: V≈© ƒê√¨nh Long</p>
                <p>Ni√™n kh√≥a: 2025 - 2026</p>
            </div>
            <div class="col-md-4">
                <h6>TR∆Ø·ªúNG ƒê·∫†I H·ªåC GTVT TP.HCM</h6>
                <p>ƒê·ªãa ch·ªâ: S·ªë 2, ƒë∆∞·ªùng V√µ Oanh, Ph∆∞·ªùng 25, Qu·∫≠n B√¨nh Th·∫°nh, TP. HCM</p>
                <p>B·∫≠c ƒë√†o t·∫°o: ƒê·∫°i h·ªçc - Ch√≠nh quy</p>
                <p>Khoa: C√¥ng ngh·ªá th√¥ng tin</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- 2. H√ÄM H·ªñ TR·ª¢ HI·ªÇN TH·ªä POPUP ƒê·∫∏P (SweetAlert2) ---

    // H√†m x√°c nh·∫≠n (thay th·∫ø confirm c≈©)
    function showConfirm(message, callback) {
        Swal.fire({
            title: 'X√°c nh·∫≠n?',
            text: message,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#4f46e5',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ƒê·ªìng √Ω',
            cancelButtonText: 'H·ªßy'
        }).then((result) => {
            if (result.isConfirmed) {
                callback();
            }
        });
    }

    // --- H·∫æT PH·∫¶N H√ÄM H·ªñ TR·ª¢ ---

    // H√†m t√¨m ki·∫øm
    function doSearch() {
        const keyword = document.getElementById('keyword-input').value;
        fetchBooks(keyword);
    }

    document.getElementById('keyword-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') doSearch();
    });

    async function fetchBooks(keyword = '') {
        const listDiv = document.getElementById('book-list');
        // Hi·ªÉn th·ªã loading
        listDiv.innerHTML = `
            <div class="text-center w-100 py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">ƒêang t√¨m ki·∫øm...</p>
            </div>
        `;

        try {
            let url = '/api/books';
            if (keyword) {
                url += `?keyword=${encodeURIComponent(keyword)}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error("L·ªói k·∫øt n·ªëi Server");

            const books = await response.json();
            listDiv.innerHTML = '';

            if (books.length === 0) {
                listDiv.innerHTML = `<div class="text-center w-100 py-5"><h5 class="text-muted">Kh√¥ng t√¨m th·∫•y s√°ch n√†o! üòû</h5></div>`;
                return;
            }

            books.forEach(book => {
                const isAvailable = book.availableQuantity > 0;

                // --- B·∫ÆT ƒê·∫¶U S·ª¨A: LOGIC HI·ªÇN TH·ªä ·∫¢NH TH·∫¨T ---
                let coverImg = '';
                if (book.image && book.image.trim() !== "") {
                    // N·∫øu c√≥ ·∫£nh th·∫≠t trong DB -> D√πng ·∫£nh th·∫≠t
                    coverImg = `/images/${book.image}`;
                } else {
                    // N·∫øu kh√¥ng -> D√πng ·∫£nh gi·∫£ (Avatar)
                    coverImg = `https://ui-avatars.com/api/?name=${encodeURIComponent(book.title)}&background=random&size=300&font-size=0.33&length=2`;
                }
                // --- K·∫æT TH√öC S·ª¨A ---

                const badge = isAvailable
                    ? `<span class="book-badge badge-stock"><i class="fas fa-check-circle me-1"></i>C√≤n ${book.availableQuantity}</span>`
                    : `<span class="book-badge badge-out"><i class="fas fa-times-circle me-1"></i>H·∫øt h√†ng</span>`;

                const btnHtml = isAvailable
                    ? `<button onclick="borrowBook(${book.id})" class="btn-borrow"><i class="fas fa-cart-plus me-2"></i>M∆∞·ª£n Ngay</button>`
                    : `<button class="btn-borrow text-muted" disabled>T·∫°m H·∫øt</button>`;

                // L∆∞u √Ω: ƒê√£ th√™m style="object-fit: cover" v√†o th·∫ª img ƒë·ªÉ ·∫£nh ƒë·∫πp h∆°n
                const html = `
                    <div class="col">
                        <div class="book-card">
                            ${badge}
                            <a href="book-details.html?id=${book.id}" class="card-img-wrapper">
                                <img src="${coverImg}" class="book-img" alt="B√¨a s√°ch">
                            </a>
                            <div class="card-body">
                                <h5 class="book-title" title="${book.title}">
                                    <a href="book-details.html?id=${book.id}" class="text-decoration-none text-dark">
                                        ${book.title}
                                    </a>
                                </h5>
                                <p class="book-author"><i class="fas fa-pen-nib me-2"></i>${book.author ? book.author.fullName : 'Ch∆∞a r√µ'}</p>
                                ${btnHtml}
                            </div>
                        </div>
                    </div>
                `;
                listDiv.innerHTML += html;
            });
        } catch (error) {
            console.error(error);
            listDiv.innerHTML = `<p class="text-danger text-center w-100">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>`;
        }
    }

    // --- 3. H√ÄM M∆Ø·ª¢N S√ÅCH (D√ôNG POPUP ƒê·∫∏P) ---
    async function borrowBook(bookId) {
        const userJson = localStorage.getItem('currentUser');

        // Ch∆∞a ƒëƒÉng nh·∫≠p
        if (!userJson) {
            showConfirm("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ m∆∞·ª£n s√°ch. ƒêi ƒë·∫øn trang ƒëƒÉng nh·∫≠p ngay?", () => {
                window.location.href = 'login.html';
            });
            return;
        }

        const user = JSON.parse(userJson);

        // ƒê√£ ƒëƒÉng nh·∫≠p -> H·ªèi x√°c nh·∫≠n
        showConfirm(`B·∫°n c√≥ ch·∫Øc mu·ªën m∆∞·ª£n cu·ªën s√°ch n√†y kh√¥ng, ${user.fullName}?`, async () => {
            // Khi ng∆∞·ªùi d√πng b·∫•m "ƒê·ªìng √Ω" th√¨ ch·∫°y code n√†y
            const btn = event.target;

            // X·ª≠ l√Ω n√∫t b·∫•m (n·∫øu t√¨m th·∫•y n√∫t)
            let originalText = "";
            if(btn) {
                originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> X·ª≠ l√Ω...';
                btn.disabled = true;
            }

            try {
                const res = await fetch(`/api/loans/borrow?readerId=${user.readerId}&bookId=${bookId}`, {
                    method: 'POST'
                });
                const msg = await res.text();

                if (res.ok) {
                    // Th√†nh c√¥ng -> Hi·ªán Popup Xanh
                    Swal.fire({
                        icon: 'success',
                        title: 'Th√†nh c√¥ng!',
                        text: msg,
                        confirmButtonColor: '#4f46e5'
                    });
                    fetchBooks(); // T·∫£i l·∫°i danh s√°ch
                } else {
                    // Th·∫•t b·∫°i -> Hi·ªán Popup ƒê·ªè
                    Swal.fire({
                        icon: 'error',
                        title: 'Kh√¥ng th·ªÉ m∆∞·ª£n!',
                        text: msg
                    });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'L·ªói', text: 'M·∫•t k·∫øt n·ªëi v·ªõi m√°y ch·ªß!' });
            } finally {
                if(btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        });
    }

    fetchBooks();

    function checkLoginState() {
        const userJson = localStorage.getItem('currentUser');
        const actionDiv = document.getElementById('user-actions');

        if (userJson) {
            const user = JSON.parse(userJson);
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName)}&background=random&color=fff`;

            actionDiv.innerHTML = `
                <div class="dropdown">
                    <button class="btn btn-light border rounded-pill py-1 px-2 d-flex align-items-center gap-2 shadow-sm" type="button" data-bs-toggle="dropdown">
                        <img src="${avatarUrl}" class="rounded-circle" width="32" height="32">
                        <span class="fw-bold small me-1">${user.fullName}</span>
                        <i class="fas fa-chevron-down small text-muted"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow mt-2">
                        <li><h6 class="dropdown-header">Xin ch√†o, ${user.fullName}!</h6></li>
                        <li><a class="dropdown-item" href="student-dashboard.html"><i class="fas fa-user-circle me-2 text-primary"></i>H·ªì s∆° c·ªßa t√¥i</a></li>

                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger fw-bold" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </div>
            `;
        } else {
            actionDiv.innerHTML = `
                <a href="login.html" class="btn btn-login rounded-pill px-4 fw-bold text-decoration-none me-2">ƒêƒÉng nh·∫≠p</a>
                <a href="register.html" class="btn btn-register rounded-pill px-4 fw-bold text-decoration-none">ƒêƒÉng k√Ω</a>
            `;
        }
    }

    // --- 4. H√ÄM ƒêƒÇNG XU·∫§T (D√ôNG POPUP ƒê·∫∏P) ---
    function logout() {
        showConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?", () => {
            localStorage.removeItem('currentUser');
            window.location.reload();
        });
    }

    checkLoginState();
</script>

</body>
</html>