<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Liên Hệ - UniLib Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- 1. Cấu hình chung --- */
        :root {
            --primary-color: #4f46e5;
            --sidebar-width: 260px;
            --bg-color: #f3f4f6;
        }

        /* Box-sizing để tính toán kích thước chuẩn */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Chặn cuộn ngang toàn trang */
        }

        /* --- 2. Sidebar (Menu trái) --- */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: white;
            border-right: 1px solid #e5e7eb;
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
        }

        .nav-link { color: #64748b; padding: 12px 15px; border-radius: 10px; font-weight: 500; margin-bottom: 5px; display: flex; align-items: center; text-decoration: none; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background-color: #eef2ff; color: var(--primary-color); }
        .nav-link i { margin-right: 12px; width: 20px; text-align: center; }
        .brand-logo { font-size: 1.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; }

        /* --- 3. Main Content (Nội dung chính - ĐÃ SỬA LỖI) --- */
        .main-content {
            /* Đẩy nội dung sang phải bằng chiều rộng sidebar */
            margin-left: var(--sidebar-width);

            /* Chiều rộng tự động lấp đầy phần còn lại */
            width: auto;

            padding: 30px;
            min-height: 100vh;
        }

        /* --- 4. Bảng và Danh sách --- */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            width: 100%;
            overflow-x: auto; /* Cho phép cuộn ngang trong bảng nếu cần */
        }
        .table { width: 100%; margin-bottom: 0; white-space: nowrap; }

        .text-truncate-custom { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; max-width: 100%; }

        /* Kích thước các cột */
        .col-id { width: 60px; }
        .col-sender { width: 20%; }
        .col-content { width: auto; }
        .col-date { width: 150px; }
        .col-status { width: 130px; }
        .col-action { width: 120px; }

        .status-badge { display: inline-block; min-width: 100px; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-align: center; }
        .status-pending { background-color: #fee2e2; color: #991b1b; }
        .status-replied { background-color: #dcfce7; color: #166534; }
        .table-hover tbody tr:hover { background-color: #f8fafc !important; cursor: pointer; }

        /* --- 5. Chi tiết tin nhắn --- */
        .detail-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            width: 100%;
            animation: fadeIn 0.3s;
        }

        .detail-header { padding: 20px 30px; border-bottom: 1px solid #f1f5f9; background: #fff; }
        .detail-body { padding: 30px; }

        .reply-area {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-control { width: 100%; }

        #detail-message {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 6. Responsive (Mobile/Tablet) --- */
        @media (max-width: 992px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand-logo"><i class="fas fa-layer-group me-2"></i> UniLib</div>
    <nav class="nav flex-column">
        <a class="nav-link" href="dashboard.html"><i class="fas fa-th-large"></i> Dashboard</a>
        <a class="nav-link" href="admin.html"><i class="fas fa-book"></i> Quản lý Sách</a>
        <a class="nav-link" href="users.html"><i class="fas fa-users"></i> Độc giả</a>
        <a class="nav-link" href="loans.html"><i class="fas fa-clipboard-list"></i> Mượn Trả</a>
        <a class="nav-link active" href="admin-contacts.html"><i class="fas fa-envelope"></i> Liên hệ</a>
        <a class="nav-link text-danger" href="index.html"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
    </nav>
</div>

<div class="main-content">

    <div id="list-view">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold m-0 text-dark">Hộp thư khách hàng</h3>
                <p class="text-muted m-0">Quản lý và phản hồi ý kiến đóng góp</p>
            </div>
            <button class="btn btn-outline-primary fw-bold" onclick="loadContacts()"><i class="fas fa-sync-alt me-2"></i>Làm mới</button>
        </div>

        <div class="table-container">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-secondary small text-uppercase">
                <tr>
                    <th class="col-id">ID</th>
                    <th class="col-sender">Người gửi</th>
                    <th class="col-content">Nội dung tóm tắt</th>
                    <th class="col-date text-center">Ngày gửi</th>
                    <th class="col-status text-center">Trạng thái</th>
                    <th class="col-action text-end">Hành động</th>
                </tr>
                </thead>
                <tbody id="contact-table-body">
                </tbody>
            </table>

            <div id="empty-state" class="text-center py-5 d-none">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">Chưa có tin nhắn liên hệ nào.</p>
            </div>
        </div>
    </div>

    <div id="detail-view" style="display: none;">
        <div class="d-flex align-items-center mb-3">
            <button class="btn btn-white border px-3 me-3" onclick="showListView()">
                <i class="fas fa-arrow-left text-muted"></i>
            </button>
            <h4 class="fw-bold m-0">Chi tiết phản hồi</h4>
        </div>

        <div class="detail-card">
            <div class="detail-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="fw-bold m-0" id="detail-name">...</h5>
                    <div class="text-muted small" id="detail-email">...</div>
                </div>
                <div class="text-end">
                    <div class="small text-muted mb-1">Thời gian gửi</div>
                    <div class="fw-bold" id="detail-date">...</div>
                </div>
            </div>

            <div class="detail-body">
                <div class="mb-4">
                    <label class="small text-muted text-uppercase fw-bold mb-2">Nội dung tin nhắn:</label>
                    <p class="fs-6 text-dark bg-light p-3 rounded" id="detail-message">...</p>
                </div>

                <div class="reply-area">
                    <label class="fw-bold text-primary mb-2"><i class="fas fa-reply me-2"></i>Phản hồi của Admin:</label>
                    <textarea id="reply-content" class="form-control mb-3" rows="5" placeholder="Nhập nội dung trả lời để gửi email cho khách..."></textarea>

                    <div class="d-flex justify-content-end gap-2">
                        <button class="btn btn-outline-danger fw-bold" onclick="deleteContact()">
                            <i class="fas fa-trash-alt me-2"></i>Xóa tin nhắn
                        </button>
                        <button class="btn btn-primary px-4 fw-bold" onclick="sendReply()">
                            <i class="fas fa-paper-plane me-2"></i>Gửi phản hồi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentContactId = null;

    function formatDate(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toLocaleString('vi-VN');
    }

    // --- API & Logic ---
    async function loadContacts() {
        try {
            const res = await fetch('/api/contacts');
            const contacts = await res.json();
            const tbody = document.getElementById('contact-table-body');
            const emptyState = document.getElementById('empty-state');

            tbody.innerHTML = '';

            if (contacts.length === 0) {
                emptyState.classList.remove('d-none');
            } else {
                emptyState.classList.add('d-none');
                contacts.forEach(c => {
                    const isPending = c.status === 'PENDING';
                    const badge = isPending
                        ? `<span class="status-badge status-pending">Chờ xử lý</span>`
                        : `<span class="status-badge status-replied">Đã phản hồi</span>`;

                    const summary = c.message.length > 60 ? c.message.substring(0, 60) + '...' : c.message;

                    const row = `
                        <tr onclick="showDetail(${c.id})">
                            <td class="text-muted fw-bold">#${c.id}</td>
                            <td>
                                <div class="fw-bold text-dark text-truncate-custom">${c.fullName}</div>
                                <div class="small text-muted text-truncate-custom">${c.email}</div>
                            </td>
                            <td><span class="text-secondary text-truncate-custom">${summary}</span></td>
                            <td class="small text-center">${formatDate(c.createdDate)}</td>
                            <td class="text-center">${badge}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary fw-bold px-3" onclick="event.stopPropagation(); showDetail(${c.id})">
                                    Chi tiết
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        } catch (e) { console.error('Lỗi tải danh sách:', e); }
    }

    async function showDetail(id) {
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('detail-view').style.display = 'block';
        currentContactId = id;
        document.getElementById('reply-content').value = '';

        try {
            const res = await fetch('/api/contacts');
            const contacts = await res.json();
            const contact = contacts.find(c => c.id === id);

            if (contact) {
                document.getElementById('detail-name').innerText = contact.fullName;
                document.getElementById('detail-email').innerText = contact.email;
                document.getElementById('detail-date').innerText = formatDate(contact.createdDate);
                document.getElementById('detail-message').innerText = contact.message;
                if (contact.adminReply) {
                    document.getElementById('reply-content').value = contact.adminReply;
                }
            }
        } catch(e) { console.error(e); }
    }

    function showListView() {
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('detail-view').style.display = 'none';
        loadContacts();
    }

    async function sendReply() {
        const replyText = document.getElementById('reply-content').value;
        if (!replyText.trim()) {
            Swal.fire('Chưa nhập nội dung', 'Vui lòng viết câu trả lời trước khi gửi.', 'warning');
            return;
        }

        try {
            const res = await fetch(`/api/contacts/${currentContactId}/reply`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reply: replyText })
            });

            if (res.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Đã lưu phản hồi!',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => { showListView(); });
            } else {
                Swal.fire('Lỗi', 'Không thể lưu phản hồi.', 'error');
            }
        } catch (e) { Swal.fire('Lỗi kết nối', 'Mất kết nối server.', 'error'); }
    }

    function deleteContact() {
        Swal.fire({
            title: 'Xóa tin nhắn này?',
            text: "Dữ liệu sẽ bị xóa vĩnh viễn.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'Xóa ngay',
            cancelButtonText: 'Hủy'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await fetch(`/api/contacts/${currentContactId}`, { method: 'DELETE' });
                    Swal.fire('Đã xóa', '', 'success').then(() => showListView());
                } catch(e) { Swal.fire('Lỗi', 'Lỗi kết nối server', 'error'); }
            }
        });
    }

    // Chạy khi tải trang
    loadContacts();
</script>

</body>
</html>