<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Sách - UniLib Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #4f46e5; --sidebar-width: 260px; --bg-color: #f3f4f6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: white; border-right: 1px solid #e5e7eb; padding: 20px; z-index: 1000; }
        .main-content { margin-left: var(--sidebar-width); padding: 30px; }
        .nav-link { color: #64748b; padding: 12px 15px; border-radius: 10px; font-weight: 500; margin-bottom: 5px; display: flex; align-items: center; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background-color: #eef2ff; color: var(--primary-color); }
        .table-container { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="mb-4 fs-4 fw-bold text-primary"><i class="fas fa-layer-group me-2"></i> UniLib</div>
    <nav class="nav flex-column">
        <a class="nav-link" href="dashboard.html"><i class="fas fa-th-large me-2"></i> Dashboard</a>
        <a class="nav-link active" href="#"><i class="fas fa-book me-2"></i> Quản lý Sách</a>
        <a class="nav-link" href="users.html"><i class="fas fa-users me-2"></i> Độc giả</a>
        <a class="nav-link" href="loans.html"><i class="fas fa-clipboard-list me-2"></i> Mượn Trả</a>
        <div class="mt-auto pt-5">
            <a class="nav-link text-danger" href="index.html" onclick="localStorage.clear()"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
        </div>
    </nav>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div><h3 class="fw-bold m-0">Kho Sách</h3><p class="text-muted m-0">Thêm, sửa và cập nhật thông tin sách</p></div>
        <button class="btn btn-primary px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#addBookModal" onclick="resetForm()">
            <i class="fas fa-plus me-2"></i> Thêm sách
        </button>
    </div>

    <div class="table-container">
        <table class="table table-hover align-middle">
            <thead class="bg-light">
                <tr><th>ID</th><th>Thông tin sách</th><th>Tác giả</th><th>Giá tiền</th><th>Trạng thái</th><th class="text-end">Hành động</th></tr>
            </thead>
            <tbody id="book-table-body"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0"><h5 class="fw-bold" id="modalTitle">Thêm Sách Mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="addBookForm">
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">TÊN SÁCH</label><input type="text" id="title" class="form-control" required></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label small fw-bold text-muted">SỐ LƯỢNG TỔNG</label><input type="number" id="quantity" class="form-control"></div>
                        <div class="col-md-6 mb-3"><label class="form-label small fw-bold text-muted">GIÁ TIỀN (VNĐ)</label><input type="number" id="price" class="form-control"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label small fw-bold text-muted">NĂM XUẤT BẢN</label><input type="number" id="publishYear" class="form-control"></div>
                        <div class="col-md-4 mb-3"><label class="form-label small fw-bold text-muted">SỐ TRANG</label><input type="number" id="pageCount" class="form-control"></div>
                        <div class="col-md-4 mb-3"><label class="form-label small fw-bold text-muted">NGÔN NGỮ</label><input type="text" id="language" class="form-control" value="Tiếng Việt"></div>
                    </div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">TÊN TÁC GIẢ</label><input type="text" id="authorName" class="form-control"></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">ẢNH BÌA</label><input type="file" id="bookImage" class="form-control" accept="image/*"></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">MÔ TẢ</label><textarea id="description" class="form-control" rows="3"></textarea></div>
                    <div class="mb-3"><label class="form-label small fw-bold text-muted">THỂ LOẠI</label>
                        <select id="category" class="form-select" required>
                            <option value="CNTT">Công nghệ thông tin</option><option value="KINHTE">Kinh tế</option><option value="VANHOC">Văn học</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0"><button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-primary px-4" onclick="saveBook()">Lưu thông tin</button></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let currentEditingId = null;
    async function loadBooks() {
        const res = await fetch('/api/books');
        const books = await res.json();
        const tbody = document.getElementById('book-table-body');
        tbody.innerHTML = books.map(book => `
            <tr>
                <td>#${book.id}</td>
                <td><div class="fw-bold">${book.title}</div><small class="text-muted">${book.category || 'Chưa phân loại'}</small></td>
                <td>${book.author ? book.author.fullName : '---'}</td>
                <td>${book.price.toLocaleString()} đ</td>
                <td><span class="badge ${book.availableQuantity > 0 ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'}">${book.availableQuantity > 0 ? 'Còn hàng' : 'Hết hàng'}</span></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-light text-primary" onclick="openEditModal(${book.id})"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-sm btn-light text-danger" onclick="deleteBook(${book.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    async function saveBook() {
        const formData = new FormData();
        formData.append('title', document.getElementById('title').value);
        formData.append('quantity', document.getElementById('quantity').value);
        formData.append('price', document.getElementById('price').value);
        formData.append('publishYear', document.getElementById('publishYear').value);
        formData.append('pageCount', document.getElementById('pageCount').value);
        formData.append('language', document.getElementById('language').value);
        formData.append('authorName', document.getElementById('authorName').value);
        formData.append('category', document.getElementById('category').value);
        formData.append('description', document.getElementById('description').value);
        const imageFile = document.getElementById('bookImage').files[0];
        if (imageFile) formData.append('image', imageFile);

        let url = '/api/books';
        let method = currentEditingId ? 'PUT' : 'POST';
        if (currentEditingId) url += '/' + currentEditingId;

        const res = await fetch(url, { method: method, body: formData });
        if (res.ok) { Swal.fire('Thành công', 'Đã lưu thông tin sách', 'success'); loadBooks(); bootstrap.Modal.getInstance(document.getElementById('addBookModal')).hide(); }
    }

    function resetForm() { currentEditingId = null; document.getElementById('addBookForm').reset(); document.getElementById('modalTitle').innerText = "Thêm Sách Mới"; }

    async function openEditModal(id) {
        const res = await fetch('/api/books/' + id);
        const book = await res.json();
        currentEditingId = id;
        document.getElementById('modalTitle').innerText = "Cập nhật Sách";
        document.getElementById('title').value = book.title;
        document.getElementById('quantity').value = book.totalQuantity;
        document.getElementById('price').value = book.price;
        document.getElementById('publishYear').value = book.publishYear || "";
        document.getElementById('pageCount').value = book.pageCount || "";
        document.getElementById('language').value = book.language || "Tiếng Việt";
        document.getElementById('authorName').value = book.author ? book.author.fullName : "";
        document.getElementById('description').value = book.description || "";
        document.getElementById('category').value = book.category || "CNTT";
        new bootstrap.Modal(document.getElementById('addBookModal')).show();
    }

    loadBooks();
</script>
</body>
</html>