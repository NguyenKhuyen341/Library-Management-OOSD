<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi Tiết Sách - UniLib</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4/bootstrap-4.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .navbar { background: white; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .book-cover-lg { width: 100%; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .badge-stock { background: #dcfce7; color: #166534; padding: 8px 16px; border-radius: 20px; font-weight: 700; }
        .synopsis-box { background: white; padding: 30px; border-radius: 16px; border: 1px solid #e2e8f0; margin-top: 30px; }
        .btn-action { padding: 12px 30px; border-radius: 10px; font-weight: 600; transition: 0.3s; }
        .btn-action:hover { transform: translateY(-2px); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold text-primary" href="index.html"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
    </div>
</nav>

<div class="container py-5">
    <div class="row gx-5">
        <div class="col-md-4 mb-4">
            <img id="book-img" src="" class="book-cover-lg mb-4">
            <div class="d-grid gap-2">
                <button onclick="borrowCurrentBook()" class="btn btn-primary btn-action" id="btn-borrow-main">
                    <i class="fas fa-book-reader me-2"></i> Mượn Sách Này
                </button>
                <button class="btn btn-outline-secondary btn-action">
                    <i class="far fa-heart me-2"></i> Thêm vào yêu thích
                </button>
            </div>
        </div>

        <div class="col-md-8">
            <span class="badge-stock" id="stock-badge">Checking...</span>
            <h1 class="fw-bold mt-3 mb-2 display-5" id="book-title">Đang tải...</h1>
            <h4 class="text-muted mb-4" id="book-author">---</h4>

            <div class="row mb-4 text-center">
                <div class="col-3 border-end">
                    <div class="small text-muted fw-bold">XUẤT BẢN</div>
                    <div class="fw-bold fs-5" id="book-year">2024</div>
                </div>
                <div class="col-3 border-end">
                    <div class="small text-muted fw-bold">SỐ TRANG</div>
                    <div class="fw-bold fs-5">350</div>
                </div>
                <div class="col-3">
                    <div class="small text-muted fw-bold">NGÔN NGỮ</div>
                    <div class="fw-bold fs-5">Tiếng Việt</div>
                </div>
            </div>

            <div class="synopsis-box">
                <h5 class="fw-bold mb-3">Tóm tắt nội dung</h5>
                <p class="text-secondary" style="line-height: 1.8;">
                    Đây là một cuốn sách tuyệt vời mang đến cho bạn những kiến thức bổ ích.
                    Hiện tại dữ liệu tóm tắt chưa được cập nhật trong Database, nhưng bạn có thể hình dung nội dung sách thông qua tiêu đề của nó.
                    Cuốn sách này phù hợp cho sinh viên chuyên ngành và những người đam mê tìm hiểu.
                </p>
                <hr>
                <div class="d-flex align-items-center gap-3 mt-3">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=random" class="rounded-circle" width="40">
                    <div>
                        <div class="small fw-bold">Thủ thư đề xuất</div>
                        <div class="small text-muted">"Cuốn này rất hay, sinh viên nên đọc!"</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('id');

async function loadBookDetails() {
        if (!bookId) {
            Swal.fire('Lỗi', 'Không tìm thấy ID sách!', 'error').then(() => window.location.href = 'index.html');
            return;
        }

        try {
            const res = await fetch(`/api/books/${bookId}`);
            if (!res.ok) throw new Error("Không tìm thấy sách");

            const book = await res.json();

            // Điền thông tin chữ
            document.title = book.title + " - UniLib";
            document.getElementById('book-title').innerText = book.title;
            document.getElementById('book-author').innerText = "Tác giả: " + (book.author ? book.author.fullName : "Chưa rõ");
            document.getElementById('book-year').innerText = book.publishYear || "2024";

            // Điền mô tả
            const descBox = document.querySelector('.synopsis-box p');
            descBox.innerText = book.description || "Chưa có mô tả chi tiết cho cuốn sách này.";

            // Xử lý tồn kho (Giữ nguyên)
            const stockEl = document.getElementById('stock-badge');
            const btn = document.getElementById('btn-borrow-main');
            if (book.availableQuantity > 0) {
                stockEl.innerText = `✅ Còn ${book.availableQuantity} cuốn trong kho`;
                stockEl.className = 'badge-stock';
                stockEl.style.background = '#dcfce7'; stockEl.style.color = '#166534';
            } else {
                stockEl.innerText = `❌ Tạm hết hàng`;
                stockEl.style.background = '#fee2e2'; stockEl.style.color = '#991b1b';
                btn.disabled = true; btn.innerText = "Tạm hết sách";
                btn.classList.remove("btn-primary"); btn.classList.add("btn-secondary");
            }

            // --- LOGIC MỚI: HIỂN THỊ ẢNH BÌA THẬT ---
            const imgEl = document.getElementById('book-img');
            if (book.image && book.image.trim() !== "") {
                imgEl.src = `/images/${book.image}`;
            } else {
                imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(book.title)}&background=random&size=500&font-size=0.33&length=2`;
            }
            // Thêm style cho đẹp
            imgEl.style.objectFit = "cover";
            // -----------------------------------------

        } catch (e) {
            console.error(e);
            Swal.fire('Lỗi', 'Không tải được thông tin sách!', 'error');
        }
    }

    // --- HÀM MƯỢN SÁCH ĐÃ ĐƯỢC NÂNG CẤP ---
    async function borrowCurrentBook() {
        const userJson = localStorage.getItem('currentUser');

        // 1. Kiểm tra đăng nhập (Dùng Popup đẹp)
        if (!userJson) {
            Swal.fire({
                title: 'Chưa đăng nhập',
                text: "Bạn cần đăng nhập để thực hiện chức năng này.",
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Đăng nhập ngay',
                cancelButtonText: 'Để sau'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = 'login.html';
                }
            });
            return;
        }

        const user = JSON.parse(userJson);

        // 2. Hỏi xác nhận mượn (Dùng Popup đẹp)
        Swal.fire({
            title: 'Xác nhận mượn?',
            text: `Bạn muốn mượn cuốn sách "${document.getElementById('book-title').innerText}"?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Vâng, Mượn ngay!',
            cancelButtonText: 'Suy nghĩ lại'
        }).then(async (result) => {
            if (result.isConfirmed) {
                // Hiệu ứng loading trên nút
                const btn = document.getElementById('btn-borrow-main');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                btn.disabled = true;

                try {
                    const res = await fetch(`/api/loans/borrow?readerId=${user.readerId}&bookId=${bookId}`, { method: 'POST' });
                    const msg = await res.text();

                    if (res.ok) {
                        Swal.fire({
                            title: 'Thành công!',
                            text: msg,
                            icon: 'success'
                        }).then(() => location.reload()); // Tải lại trang để cập nhật số lượng
                    } else {
                        Swal.fire('Thất bại', msg, 'error');
                    }
                } catch (e) {
                    Swal.fire('Lỗi', 'Không thể kết nối đến máy chủ', 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        });
    }

    loadBookDetails();
</script>

</body>
</html>