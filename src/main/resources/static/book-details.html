<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chi Tiết Sách - UniLib</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary: #4f46e5; --dark: #1e293b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; min-height: 100vh; }

        /* NAVBAR */
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 0; border-bottom: 1px solid #e2e8f0; }
        .navbar-brand { font-weight: 800; color: var(--primary) !important; font-size: 1.5rem; }
        .nav-link { font-weight: 600; color: #64748b !important; margin: 0 10px; transition: 0.3s; }
        .nav-link:hover, .nav-link.active { color: var(--primary) !important; }

        /* HERO BACKDROP */
        .hero-backdrop { position: relative; background: #1e293b; height: 400px; overflow: hidden; }
        .backdrop-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: blur(30px) brightness(0.5); transform: scale(1.1); }

        /* MAIN CARD */
        .main-card { background: white; border-radius: 32px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); margin-top: -200px; position: relative; z-index: 10; padding: 50px; }
        .book-cover-img { width: 100%; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); aspect-ratio: 2/3; object-fit: cover; }

        /* META BOXES */
        .meta-box { background: #fff; border: 1px solid #f1f5f9; border-radius: 20px; padding: 25px 10px; text-align: center; height: 100%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); transition: 0.3s; }
        .meta-box:hover { transform: translateY(-5px); border-color: var(--primary); }
        .meta-label { font-size: 0.65rem; text-transform: uppercase; color: #94a3b8; font-weight: 800; margin-bottom: 8px; }
        .meta-value { font-size: 1rem; font-weight: 800; color: #1e293b; }
        .meta-icon { font-size: 1.4rem; color: var(--primary); margin-bottom: 10px; display: block; }

        /* SÁCH GỢI Ý */
        .suggested-card { border: none; border-radius: 20px; transition: 0.3s; background: white; overflow: hidden; height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .suggested-card:hover { transform: translateY(-10px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .suggested-img { height: 200px; object-fit: cover; width: 100%; }

        .btn-borrow-main { background: var(--primary); color: white; border-radius: 14px; padding: 16px; font-weight: 700; border: none; transition: 0.3s; }
        .btn-borrow-main:hover { background: #4338ca; transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); }

        /* FOOTER */
        footer {
        background: #0f172a;
        color: #94a3b8;
        margin-top: auto;
        padding: 50px 0 30px;
        border-top: none;
        }
        footer h5 { color: white; font-weight: 700; }
        footer .text-primary { color: #4f46e5 !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
        <a class="navbar-brand" href="index.html"><i class="fas fa-book-open-reader me-2"></i>UniLib.</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Trang chủ</a></li>
                <li class="nav-item"><a class="nav-link active" href="catalog.html">Danh mục</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Sách mới</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Về chúng tôi</a></li>
            </ul>
            <div id="user-actions" class="d-flex align-items-center gap-2"></div>
        </div>
    </div>
</nav>

<div class="hero-backdrop">
    <img src="" id="hero-blur" class="backdrop-img">
</div>

<div class="container pb-5">
    <div class="main-card">
        <div class="row gx-5">
            <div class="col-md-4 text-center">
                <img id="book-img" src="" class="book-cover-img mb-4">
                <div class="d-grid gap-2">
                    <button onclick="borrowBook()" id="btn-loan" class="btn btn-borrow-main shadow">
                        <i class="fas fa-cart-plus me-2"></i> MƯỢN SÁCH NGAY
                    </button>
                </div>
            </div>

            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span id="stock-badge" class="badge rounded-pill bg-success px-3 py-2">Checking...</span>
                    <span class="text-muted small"><i class="fas fa-eye me-1"></i> 1,204 lượt xem</span>
                </div>
                <h1 class="fw-bold display-5 mb-1" id="book-title">Loading...</h1>
                <h4 class="text-primary mb-5 fw-bold" id="book-author">---</h4>

                <div class="row g-3 mb-5">
                    <div class="col-6 col-sm-3"><div class="meta-box"><i class="fas fa-calendar-alt meta-icon"></i><div class="meta-label">Năm XB</div><div class="meta-value" id="val-year">---</div></div></div>
                    <div class="col-6 col-sm-3"><div class="meta-box"><i class="fas fa-layer-group meta-icon"></i><div class="meta-label">Thể Loại</div><div class="meta-value" id="val-cat">---</div></div></div>
                    <div class="col-6 col-sm-3"><div class="meta-box"><i class="fas fa-file-alt meta-icon"></i><div class="meta-label">Số Trang</div><div class="meta-value" id="val-pages">---</div></div></div>
                    <div class="col-6 col-sm-3"><div class="meta-box"><i class="fas fa-language meta-icon"></i><div class="meta-label">Ngôn Ngữ</div><div class="meta-value" id="val-lang">---</div></div></div>
                </div>

                <div class="mb-4">
                    <h5 class="fw-bold border-bottom pb-3 mb-3">Giới thiệu nội dung</h5>
                    <p class="text-secondary" id="book-desc" style="line-height: 1.8;">...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-5">
        <h4 class="fw-bold mb-4 border-start border-4 border-primary ps-3">Sách cùng thể loại</h4>
        <div class="row row-cols-1 row-cols-md-4 g-4" id="suggestion-list">
            </div>
    </div>
</div>
<footer>
    <div class="container">
        <div class="row g-4">
            <div class="col-md-4">
                <h5 class="mb-3">Về UniLib</h5>
                <p class="small">Hệ thống thư viện số hiện đại dành cho sinh viên.</p>
            </div>
            <div class="col-md-4">
                <h5 class="mb-3">Liên hệ</h5>
                <p class="small mb-1"><i class="fas fa-map-marker-alt me-2 text-primary"></i> 2 Võ Oanh, Quận Bình Thạnh, TP.HCM</p>
                <p class="small"><i class="fas fa-envelope me-2 text-primary"></i> contact@unilib.edu.vn</p>
            </div>
            <div class="col-md-4 text-md-end">
                <p class="small text-muted">&copy; 2024 UniLib Library System.</p>
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const bookId = new URLSearchParams(window.location.search).get('id');

    async function init() {
        checkLoginState();
        try {
            const res = await fetch('/api/books/' + bookId);
            const book = await res.json();

            document.getElementById('book-title').innerText = book.title;
            document.getElementById('book-author').innerText = book.author ? book.author.fullName : "Chưa rõ";
            document.getElementById('val-year').innerText = book.publishYear || "2024";
            document.getElementById('val-cat').innerText = book.category || "Tổng hợp";
            document.getElementById('val-pages').innerText = book.pageCount || "---";
            document.getElementById('val-lang').innerText = book.language || "Tiếng Việt";
            document.getElementById('book-desc').innerText = book.description || "Chưa có mô tả.";

            const imgSrc = book.image ? `/images/${book.image}` : `https://ui-avatars.com/api/?name=${encodeURIComponent(book.title)}&background=random&size=500`;
            document.getElementById('book-img').src = imgSrc;
            document.getElementById('hero-blur').src = imgSrc;

            const badge = document.getElementById('stock-badge');
            if (book.availableQuantity > 0) badge.innerText = `Còn ${book.availableQuantity} cuốn`;
            else { badge.innerText = "Hết sách"; badge.className = "badge rounded-pill bg-danger px-3 py-2"; document.getElementById('btn-loan').disabled = true; }

            loadSuggestions(book.category);
        } catch (e) { console.error(e); }
    }

    async function loadSuggestions(category) {
        const res = await fetch(`/api/books?category=${category}`);
        const books = await res.json();
        const list = document.getElementById('suggestion-list');
        list.innerHTML = books.filter(b => b.id != bookId).slice(0, 4).map(b => `
            <div class="col">
                <div class="suggested-card shadow-sm">
                    <a href="book-details.html?id=${b.id}">
                        <img src="${b.image ? '/images/' + b.image : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(b.title) + '&background=random'}" class="suggested-img">
                    </a>
                    <div class="p-3">
                        <h6 class="fw-bold mb-1 text-truncate">${b.title}</h6>
                        <small class="text-muted">${b.author ? b.author.fullName : '---'}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function checkLoginState() {
        const userJson = localStorage.getItem('currentUser');
        const actionDiv = document.getElementById('user-actions');
        if (userJson) {
            const user = JSON.parse(userJson);
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName)}&background=random&color=fff`;
            actionDiv.innerHTML = `
                <div class="dropdown">
                    <button class="btn btn-light border rounded-pill py-1 px-2 d-flex align-items-center gap-2 shadow-sm" type="button" data-bs-toggle="dropdown">
                        <img src="${avatarUrl}" class="rounded-circle" width="32" height="32">
                        <span class="fw-bold small">${user.fullName}</span>
                        <i class="fas fa-chevron-down small text-muted"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2">
                        <li><a class="dropdown-item" href="student-dashboard.html">Hồ sơ của tôi</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger fw-bold" href="#" onclick="localStorage.clear(); location.reload();">Đăng xuất</a></li>
                    </ul>
                </div>`;
        } else {
            actionDiv.innerHTML = `<a href="login.html" class="btn btn-primary rounded-pill px-4 fw-bold">Đăng nhập</a>`;
        }
    }

    async function borrowBook() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) return Swal.fire('Thông báo', 'Vui lòng đăng nhập!', 'info');
        const res = await fetch(`/api/loans/borrow?readerId=${user.readerId}&bookId=${bookId}`, { method: 'POST' });
        const msg = await res.text();
        if (res.ok) Swal.fire('Thành công', msg, 'success');
        else Swal.fire('Thất bại', msg, 'error');
    }

    init();
</script>
</body>
</html>